<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Azure DevOps - Uptime Docs</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.3/dist/mermaid.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Azure DevOps | Uptime Docs</title> <meta name="generator" content="Jekyll v4.3.0" /> <meta property="og:title" content="Azure DevOps" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Confluence for Uptime Support and Delivery" /> <meta property="og:description" content="Confluence for Uptime Support and Delivery" /> <link rel="canonical" href="https://just-the-docs.github.io/docs/Delivery-kit/Install%20and%20Configuration%20Guide/01%20Azure%20DevOps" /> <meta property="og:url" content="https://just-the-docs.github.io/docs/Delivery-kit/Install%20and%20Configuration%20Guide/01%20Azure%20DevOps" /> <meta property="og:site_name" content="Uptime Docs" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Azure DevOps" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Confluence for Uptime Support and Delivery","headline":"Azure DevOps","url":"https://just-the-docs.github.io/docs/Delivery-kit/Install%20and%20Configuration%20Guide/01%20Azure%20DevOps"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Uptime Docs </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Build Kit category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/docs/Build-Kit" class="nav-list-link">Build Kit</a><ul class="nav-list "><li class="nav-list-item "><a href="/docs/Build-Kit/CICD%20Pipelines.html" class="nav-list-link">CICD Pipelines</a></li><li class="nav-list-item "><a href="/docs/Build-Kit/Data%20Protection%20Impact%20Assessment%20(DPIA).html" class="nav-list-link">Data Protection Impact Assessment (DPIA)</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Definition of Terms category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/docs/Definition-of-Terms" class="nav-list-link">Definition of Terms</a><ul class="nav-list "></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Delivery Kit category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/docs/Delivery-kit/" class="nav-list-link">Delivery Kit</a><ul class="nav-list "><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Install and Configuration Guide category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/docs/Delivery-kit/Install%20and%20Configuration%20Guide" class="nav-list-link">Install and Configuration Guide</a><ul class="nav-list"><li class="nav-list-item active"> <a href="/docs/Delivery-kit/Install%20and%20Configuration%20Guide/01%20Azure%20DevOps" class="nav-list-link active">Azure DevOps</a> </li><li class="nav-list-item "> <a href="/docs/Delivery-kit/Install%20and%20Configuration%20Guide/02%20UPtime%20Portal/01%20Install%20Process.html" class="nav-list-link">UPtime Portal</a> </li></ul></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Uptime Docs" aria-label="Search Uptime Docs" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//uptime.dxc.com/" class="site-button" target="_blank" rel="noopener noreferrer" > DXCi Uptime </a> </li> <li class="aux-nav-list-item"> <a href="https:////uptime.digitaldemostudio.com/" class="site-button" target="_blank" rel="noopener noreferrer" > DXCi Showcase </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/docs/Delivery-kit/">Delivery Kit</a></li> <li class="breadcrumb-nav-list-item"><a href="/docs/Delivery-kit/Install%20and%20Configuration%20Guide">Install and Configuration Guide</a></li> <li class="breadcrumb-nav-list-item"><span>Azure DevOps</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <details open=""> <summary class="text-delta"> Table of contents </summary> <ol id="markdown-toc"> <li><a href="#introduction-to-components" id="markdown-toc-introduction-to-components">Introduction to Components</a> <ol> <li><a href="#build-pipelines" id="markdown-toc-build-pipelines">Build Pipelines</a></li> <li><a href="#releases-pipelines" id="markdown-toc-releases-pipelines">Releases Pipelines</a></li> </ol> </li> <li><a href="#azure-devops-release-pipeline" id="markdown-toc-azure-devops-release-pipeline">Azure DevOps Release Pipeline</a> <ol> <li><a href="#azure-prerequisites" id="markdown-toc-azure-prerequisites">Azure Prerequisites</a></li> </ol> </li> <li><a href="#deployment-steps-breakdown" id="markdown-toc-deployment-steps-breakdown">Deployment steps breakdown</a> <ol> <li><a href="#setting-up-terraform-pipeline" id="markdown-toc-setting-up-terraform-pipeline">Setting up Terraform pipeline</a></li> <li><a href="#creating-release-pipeline" id="markdown-toc-creating-release-pipeline">Creating Release Pipeline</a></li> <li><a href="#declaring-the-variables-for-the-pipeline" id="markdown-toc-declaring-the-variables-for-the-pipeline">Declaring the variables for the pipeline</a></li> <li><a href="#after-deploying-an-error-will-occur-due-to-restriction-on-permissions-redeploy-using-new-agent-deployed-on-uptime-resource-groups-vm" id="markdown-toc-after-deploying-an-error-will-occur-due-to-restriction-on-permissions-redeploy-using-new-agent-deployed-on-uptime-resource-groups-vm">After deploying, an error will occur due to restriction on permissions. Redeploy using new Agent deployed on Uptime resource group’s VM</a></li> <li><a href="#notes" id="markdown-toc-notes">Notes:</a></li> </ol> </li> <li><a href="#deployment-best-practices" id="markdown-toc-deployment-best-practices">Deployment Best Practices</a> <ol> <li><a href="#creating-github-organization" id="markdown-toc-creating-github-organization">Creating Github Organization</a> <ol> <li><a href="#recommended-forking-repository" id="markdown-toc-recommended-forking-repository"><strong>RECOMMENDED:</strong> Forking repository</a></li> </ol> </li> <li><a href="#uploading-the-source-code-repository-files-into-your-github-org" id="markdown-toc-uploading-the-source-code-repository-files-into-your-github-org">Uploading the source code repository files into your Github Org</a> <ol> <li><a href="#updating-the-fork-from-remote-branch" id="markdown-toc-updating-the-fork-from-remote-branch">Updating the fork from remote branch</a></li> </ol> </li> </ol> </li> <li><a href="#update-best-practices" id="markdown-toc-update-best-practices">Update Best Practices</a> <ol> <li><a href="#updating-the-fork-from-remote-branch-1" id="markdown-toc-updating-the-fork-from-remote-branch-1">Updating the fork from remote branch</a></li> </ol> </li> </ol> </details> <h1 id="introduction-to-components"> <a href="#introduction-to-components" class="anchor-heading" aria-labelledby="introduction-to-components"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction to Components </h1> <p>This documentation covers the definition of components in Azure DevOps existing in Showcase. Please refer to documents <a href="02%20Deployment%20Steps.md">Deployment Steps</a> to start working on a new Pipelines.</p> <ol> <li>Build Pipelines</li> <li>Release Pipelines</li> </ol> <h2 id="build-pipelines"> <a href="#build-pipelines" class="anchor-heading" aria-labelledby="build-pipelines"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build Pipelines </h2> <p><img src="../../../assets/images/delivery-kit/azure-devops-1.png" alt="best-practices" /></p> <ol> <li> <p>This shows the Pipelines page where the user can view the Pipeline builds. Pipelines <strong>automatically builds and tests code projects in a repository to make them available. This tests and builds the code to make it ready for release/deployment</strong>.</p> </li> <li> <p>In this section, Recently run pipelines can be viewed across the page. Pipelines below as can be seen, shows the:<br /> <img src="../../../assets/images/delivery-kit/azure-devops-2.png" alt="best-practices" /><br /> 2.1. Pipeline name<br /> 2.2. Last commit<br /> 2.3. User published/updated the pipeline<br /> 2.4. Branch<br /> 2.5. Last run date</p> </li> <li> <p>Clicking on a certain Pipeline name will show the recent builds ran in that pipeline. <img src="../../../assets/images/delivery-kit/azure-devops-3.png" alt="best-practices" /></p> </li> </ol> <h2 id="releases-pipelines"> <a href="#releases-pipelines" class="anchor-heading" aria-labelledby="releases-pipelines"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Releases Pipelines </h2> <p><img src="../../../assets/images/delivery-kit/azure-devops-6.png" alt="best-practices" /></p> <ol> <li> <p>List shows the existing Release Pipelines. Release Pipelines are the next step of the Build Pipelines as discussed before this topic.</p> </li> <li> <p>This will let you manually create a new release pipeline, or in this case for Uptime, we imported a release pipeline where the assets are already indicated, which only needs a slight modification.</p> </li> <li> <p>Releases section shows the releases deployed. The green boxes you can see that are under the Stages column shows the stages that have been deployed. White boxes that has no checks means in that release, those have not been included for that release. As you can see in the Release-35, we only deployed a release for the <i>frontend</i> codebase</p> </li> <li> <p>Clicking on Edit will then allow to modify the Release, to prepare for the new release.</p> </li> <li> <p>Clicking one of the Artifacts will allow you which version to pick before deploying that release pipeline. Note that this will change the artifact which will reflect all stages and steps related to it. <img src="../../../assets/images/delivery-kit/azure-devops-4.png" alt="best-practices" /></p> </li> <li> <p>Clicking on Create Release will allow you to select a stage where you can trigger it manually or automatically, this will also allow you to select a version of the Artifacts loaded in that Release.</p> </li> </ol> <h1 id="azure-devops-release-pipeline"> <a href="#azure-devops-release-pipeline" class="anchor-heading" aria-labelledby="azure-devops-release-pipeline"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Azure DevOps Release Pipeline </h1> <h2 id="azure-prerequisites"> <a href="#azure-prerequisites" class="anchor-heading" aria-labelledby="azure-prerequisites"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Azure Prerequisites </h2> <ul> <li>Azure DevOps organisation with a paid tier Microsoft-hosted agent as the initial terraform may exceed the free tier time limit</li> <li>Azure DevOps Terraform and File Creator Extensions</li> <li>Azure AD account with access rights to Azure DevOps and rights to configure a Service Principle with Contribute Permission on Subscription (Request for Service Principle) &lt; get the Azure Owner to setup the Service Connection directly to the Subscription used for the Terraform depolyment &gt;</li> <li>Infrastructure: https://github.dxc.com/Uptime/terraform/tree/master/cps</li> <li>GitHub Enterprise to link on AzureDevOps (Terraform, Deployment pipelines)</li> <li>GitHub PAT (Personal Access Token) with rights to create a GitHub Enterprise Server service connection to https://github.dxc.com</li> <li>SonarQube installed in order to test code quality for backend APIs</li> </ul> <h1 id="deployment-steps-breakdown"> <a href="#deployment-steps-breakdown" class="anchor-heading" aria-labelledby="deployment-steps-breakdown"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Deployment steps breakdown </h1> <h2 id="setting-up-terraform-pipeline"> <a href="#setting-up-terraform-pipeline" class="anchor-heading" aria-labelledby="setting-up-terraform-pipeline"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up Terraform pipeline </h2> <ul> <li> <p>Importing/Forking project for repositories Github source code:</p> <blockquote> <p>https://github.dxc.com/Uptime/terraform/tree/master/cps</p> </blockquote> </li> <li> <p>Creating a Pipeline / Connecting your Github to Azure DevOps</p> <blockquote> <p>NOTE: If you don’t have Github Organization yet, you can follow this guide <a href="03%20Deployment%20Best%20Practices.md">Deployment Best Practices</a></p> </blockquote> <ol> <li>Go to Pipelines, and click New Pipeline<br /> <img src="../../../assets//images/delivery-kit/deployment-1.png" alt="new-pipeline" /></li> <li>Click new connection <img src="../../../assets//images/delivery-kit/deployment-2.png" alt="new-pipeline" /></li> <li>Enter your PAT, and Enterprise URL (ex. https://github.dxc.com) <img src="../../../assets//images/delivery-kit/deployment-3.png" alt="new-pipeline" /></li> <li>Select All Repositories from the dropdown then select your Github Organization/repository <img src="../../../assets//images/delivery-kit/deployment-4.png" alt="new-pipeline" /></li> <li>Click “Starter Pipeline” then click Save and Run</li> </ol> <blockquote> <p>If an error occurs about SonarQube, edit the YAML file and remove the SonarQube block if SonarQube is not present in current ADO instance. Select the version then click ‘Run’ button on the upper right of the page.</p> </blockquote> </li> </ul> <h2 id="creating-release-pipeline"> <a href="#creating-release-pipeline" class="anchor-heading" aria-labelledby="creating-release-pipeline"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Creating Release Pipeline </h2> <blockquote> <p>For this steps, we will be importing a preset file that will add artifacts, and stages. For more information on creating from scratch, you can look up at: ‘link here’</p> </blockquote> <ol> <li> <p>Go to Releases &gt; click New &gt; Import release pipeline <img src="../../../assets//images/delivery-kit/import.PNG" alt="new-pipeline" /></p> </li> <li> <p>It will be looking for the Artifact that came from the template release pipeline we imported, in this case, we should remove the current artifact. Under Artifacts, click _Uptime.terraform, then click Delete. <img src="../../../assets//images/delivery-kit/deployment-6.png" alt="new-pipeline" /></p> </li> <li> <p>Click ‘+ Add’ beside Artifacts, and select your Source on the right sidebar that appears, then click Add. The remaining 2 options will be autofilled once Source is selected <img src="../../../assets//images/delivery-kit/deployment-7.png" alt="new-pipeline" /></p> </li> <li> <p>Click on ‘qa’ from Stages, and rename it. You can now close the side window</p> </li> <li> <p>Click on “1 job, 7 tasks” under Stages</p> </li> <li> <p>You will be able to see 7 tasks, which are 3 File Creators, and Terraform tasks</p> </li> <li> <p>An error will appear on some tasks, which could be under Agent Job, and File Creators. In this case, we will install extensions that would be used for these type of tasks. Link: https://dev.azure.com/WMShowCase/_redirect?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Deliostruyf.build-task%26targetId%3Da58beef4-4e5e-488a-b5e2-3d2b9731a95e <img src="../../../assets//images/delivery-kit/deployment-8.png" alt="new-pipeline" /></p> </li> <li> <p>Once done, replace the tasks’ directory name using the build pipeline path, you can also view the folder by clicking the 3 dots beside the text-field (ex. $(System.DefaultWorkingDirectory)/_Uptime-DDS.terraform-1/provision/cps/locals.tf)</p> </li> <li> <p>Terraform had a breaking change on the latest version, due to this, we must change the 3rd File Creator’s contents by switching the version to “2.93.1”</p> </li> <li> <p>Next, we will clear out ‘Agent Job’ error:</p> <p>10.1. Click ‘Agent Job’</p> <p>10.2. On the right pane, select ‘Agent pool’ dropdown</p> <p>10.3. Select your Hosted, in our case ‘Azure Pipelines’</p> <p>10.4. Select from the dropdown ‘Agent Specification’ &gt; latest Ubuntu version</p> <p>10.5. Once done, rename your Pipeline, on the top portion beside ‘All Pipelines &gt; provision - Copy’ by just hovering and clicking to rename</p> </li> <li> <p>Hit ‘Save’</p> </li> </ol> <p>## IMPORTANT: Resetting the Subscription IDs from the imported pipeline template</p> <ol> <li>For the 2 Terraform: azurerm tasks: azurerm plan, azurerm apply: <ul> <li>Go to Tasks</li> <li>Select one of the Terraform tasks mentioned above</li> <li>Under command, select init</li> <li>AzureRM backend configuration section will appear</li> <li>Fill out the remaining blank fields with the right values</li> <li>Hit ‘Save’</li> <li>Repeat for the remaining Terraform azurerm task <img src="../../../assets//images/delivery-kit/azurerm-1.png" alt="new-pipeline" /></li> </ul> </li> </ol> <h2 id="declaring-the-variables-for-the-pipeline"> <a href="#declaring-the-variables-for-the-pipeline" class="anchor-heading" aria-labelledby="declaring-the-variables-for-the-pipeline"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Declaring the variables for the pipeline </h2> <ol> <li> <p>Go to Releases -&gt; click Your Pipeline -&gt; click Edit <img src="../../../assets//images/delivery-kit/deployment-5.png" alt="new-pipeline" /></p> </li> <li> <p>You will be able to see your Artifacts, and Stages. Click Variables on the top selections</p> </li> <li> <p>Setting up Variable groups:</p> <p>Setting up Variable groups for sensitive data, like secrets, passwords, etc.</p> <p>3.1. Click on ‘Manage variable groups’</p> <p>3.2. Click on ‘+ Variable Group’</p> <p>3.3. Name your Variable Group</p> <p>3.4. Click ‘+Add’ under Variable Group</p> <p>3.5. Add these 3:</p> <ul> <li>az_tenant - <strong><em>[your service principle]</em></strong> - Found in Azure &gt; Azure Active Directory</li> <li>az_username - <strong><em>[your service principle]</em></strong> - If app has been registered, go to: Azure &gt; Azure Active Directory &gt; App registrations &gt; All applications &gt; Find app to use in the deployment - seen in column ‘Application (client) ID’</li> <li> <p>az_password - <strong><em>[your service principle]</em></strong> - If app has been registered, go to: Azure &gt; Azure Active Directory &gt; App registrations &gt; All applications &gt; Select app &gt; Certificates &amp; Secrets &gt; Secret ID</p> <p><img src="../../../assets//images/delivery-kit/deployment-9.png" alt="new-pipeline" /></p> </li> </ul> <p>3.6. Hit ‘Save’</p> <p>3.7. Go back to Variables</p> <p>3.8. Select ‘Variable Groups’</p> <p>3.9. Select your created/existing Variable Group created (Service Principles)</p> </li> <li> <p>Setting up Pipeline Variables</p> <p>4.1. Change the az_subscription using your own azure subscription id</p> <p>4.2. Change the environment name, base on what environment this gets deployed</p> <p>4.3. Key would be the folder name in azure storage that we will use to store terraform.state, in this case you can rename it as:</p> <p>your-new-directory &gt;/$(env)/terraform.tfstate</p> <p>4.4. uid (unit_id) keep it empty to auto-generate unit_id, and should be populated if we are updating</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UID can only contain alphanumeric characters between 3-24 characters, you can use any input - or if needed, you can generate your UID randomly using this script, can be edited by going to:  
 1. Edit Release  
 2. Click 1 Job under Stages  
 3. Click 7 Tasks under provision  
 4. Click the 2nd File Creator and enter on the first line:  
 resource "random_id" "env_uid" {
 byte_length = 4
 }
 uid = lower(random_id.env_uid.hex)
</code></pre></div> </div> <p>4.5. Tier = P1V2 default used for Staging, for more details about pricing and specification, you can view it here:</p> <p>Enter Excel File for the Pricing and Specifications here</p> <p>4.6. Hit ‘Save’</p> </li> <li> <p>Setting up Tasks, for Terraform - linking Service Principles in Azure subscription</p> <p>5.1. Go to Releases &gt; Click your release pipeline &gt; Click Edit</p> <p>5.2. Click Tasks</p> <p>5.3. On the 3 Terraforms job: azurerm init, azurerm plan, azurerm apply - change the Azure Subscription using your Service Connection</p> <p>5.4 Click on the ‘Agent Job’, and on the Agent Pool select your current Agent Pool to use in deploying</p> <p>5.5 On the ‘Agent Specification’, select latest ubuntu-latest version</p> <p>5.6 Click on the 2nd file creator, and under File Content - declare these in the locals block under the ‘molecule_node’:</p> <ul> <li>redis_sku_name = “Premium”</li> <li>redis_family = “P”</li> </ul> <p>5.7 File Pathname should be the same with the deployed build pipeline path, the ellipsis on the left of the field value can be used and then point to the required location (path shown in image below): <img src="../../../..../../../assets//images/delivery-kit/deployment-file-path-1.png" alt="provision" /></p> <p>5.8 On the same file creator shown in the image on the previous step, change the version to “2.93.1”, versions above has a breaking change that will cause issues running the release pipeline.</p> <p>5.9 On the same File Creator, replace the resource group name, storage account name, and container name</p> </li> <li> <p>Creating a new release</p> <p>6.1. Go to ‘Releases’</p> <p>6.2. Click ‘Create Release’ on the upper right portion of the screen</p> <p>6.3. Click ‘Create’</p> </li> </ol> <h2 id="after-deploying-an-error-will-occur-due-to-restriction-on-permissions-redeploy-using-new-agent-deployed-on-uptime-resource-groups-vm"> <a href="#after-deploying-an-error-will-occur-due-to-restriction-on-permissions-redeploy-using-new-agent-deployed-on-uptime-resource-groups-vm" class="anchor-heading" aria-labelledby="after-deploying-an-error-will-occur-due-to-restriction-on-permissions-redeploy-using-new-agent-deployed-on-uptime-resource-groups-vm"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> After deploying, an error will occur due to restriction on permissions. Redeploy using new Agent deployed on Uptime resource group’s VM </h2> <ul> <li>Details and instructions can be located at <a href="../How%20to%20Set-up%20a%20Self%20host%20Agent%20on%20UPtime%20Resource%20Group.md">here</a></li> </ul> <h2 id="notes"> <a href="#notes" class="anchor-heading" aria-labelledby="notes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Notes: </h2> <p>apim.azurerm_api_management.srg could take 60-120 mins in creating so a paid agent pool might be required to increase timeout</p> <p>CosmosDB only has a maximum of 44 characters, if issue is present:</p> <blockquote> <p>creating Database Account: (Name “cosmos-ms-uptime-base-api-sc2-eastus-c129bd42” / Resource Group “rg-func-ms-uptime-base-api-sc2-eastus-c129bd42”): creating/updating CosmosDB Account “cosmos-ms-uptime-base-api-sc2-eastus-c129bd42” (Resource Group “rg-func-ms-uptime-base-api-sc2-eastus-c129bd42”): documentdb.DatabaseAccountsClient#CreateOrUpdate: Failure sending request: StatusCode=400 – Original Error: Code=”BadRequest” Message=”DatabaseAccount name ‘cosmos-ms-uptime-base-api-sc2-eastus-c129bd42’ is not valid since it is less than 3 characters or more than 44 characters long.\r\nActivityId: afcc278f-4e6a-4ca1-afd1-3116b6d09b21, Microsoft.Azure.Documents.Common/2.14.0 change it in the Terraform repository: cps/services/uptime_ms/main.tf</p> </blockquote> <p><img src="../../../..../../../assets//images/delivery-kit/cosmosdb-maxlength.png" alt="new-pipeline" /></p> <h1 id="deployment-best-practices"> <a href="#deployment-best-practices" class="anchor-heading" aria-labelledby="deployment-best-practices"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Deployment Best Practices </h1> <p>This documentation covers the best practices in setting up your Azure for UpTime application requirements, and APIs. In this section, this will guide us in setting up:</p> <ol> <li>Github Organization</li> <li>Getting Terraform code from Uptime Terraform Github source</li> </ol> <h2 id="creating-github-organization"> <a href="#creating-github-organization" class="anchor-heading" aria-labelledby="creating-github-organization"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Creating Github Organization </h2> <ol> <li>Login to your Github</li> <li> <p>Click the ‘+’ icon on the upper right corner, beside your profile icon</p> <p><img src="../../../..../../../assets/images/delivery-kit/bestp-1.png" alt="best-practices" /></p> </li> <li> <p>Select ‘New Organization’</p> <p><img src="../../../..../../../assets/images/delivery-kit/bestp-2.png" alt="best-practices" /></p> </li> <li>Enter your Organization account name</li> </ol> <blockquote> <p>REMEMBER: Take note of your Organization Name since this will be used for the variables used in Azure DevOps, and Uptime code deployment</p> </blockquote> <p><img src="../../../..../../../assets/images/delivery-kit/bestp-3.png" alt="best-practices" /></p> <ol> <li>Add Organization members who will be working on deploying Azure</li> </ol> <blockquote> <p>NOTE: Creating/Forking repository will be under your Github Organization created recently</p> </blockquote> <h3 id="recommended-forking-repository"> <a href="#recommended-forking-repository" class="anchor-heading" aria-labelledby="recommended-forking-repository"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>RECOMMENDED:</strong> Forking repository </h3> <ol> <li>Go into https://github.dxc.com/Uptime/terraform/tree/master/cps</li> <li> <p>On the upper right corner, click the button ‘Fork’</p> <p><img src="../../../..../../../assets/images/delivery-kit/bestp-4.png" alt="best-practices" /></p> </li> <li>Select your Organization created in this guide.</li> </ol> <h2 id="uploading-the-source-code-repository-files-into-your-github-org"> <a href="#uploading-the-source-code-repository-files-into-your-github-org" class="anchor-heading" aria-labelledby="uploading-the-source-code-repository-files-into-your-github-org"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Uploading the source code repository files into your Github Org </h2> <ol> <li> <p>Create your Github Repository</p> <p><img src="../../../..../../../assets/images/delivery-kit/bestp-5.png" alt="best-practices" /></p> </li> <li> <p>Add the ‘Repository Name’, and make sure that Public is not ticked for security purposes.</p> <blockquote> <p>OPTION: You can add a Readme.md for description or markdown files can also be created later.</p> </blockquote> </li> </ol> <p><img src="../../../..../../../assets/images/delivery-kit/bestp-6.png" alt="best-practices" /></p> <ol> <li>Export then Import the Uptime’s Terraform source code from the development team in your Terraform repository.</li> </ol> <blockquote> <p>https://github.dxc.com/Uptime/terraform/tree/master/cps</p> </blockquote> <h3 id="updating-the-fork-from-remote-branch"> <a href="#updating-the-fork-from-remote-branch" class="anchor-heading" aria-labelledby="updating-the-fork-from-remote-branch"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Updating the fork from remote branch </h3> <ol> <li>Click ‘Fetch Upstream’, and click ‘Fetch and Merge’. This only updates the current branch. You can also check the comparisons to check any changes made from the remote vs forked branch.</li> </ol> <p><img src="../../../assets/images/delivery-kit/update-repository.png" alt="best-practices" /></p> <ol> <li> <p>Once done, the build pipelines on DevOps will automatically update. You can check it on Azure DevOps as well, where the related repository is in the build pipeline.</p> </li> <li> <p>If the build goes successful, go to Releases branch and Create a release, and select the version you want to deploy. The steps can be found at <a href="Azure%20DevOps.md">Azure DevOps</a> at section Releases, #4.</p> </li> </ol> <h1 id="update-best-practices"> <a href="#update-best-practices" class="anchor-heading" aria-labelledby="update-best-practices"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Update Best Practices </h1> <h2 id="updating-the-fork-from-remote-branch-1"> <a href="#updating-the-fork-from-remote-branch-1" class="anchor-heading" aria-labelledby="updating-the-fork-from-remote-branch-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Updating the fork from remote branch </h2> <ol> <li> <p>Click ‘Fetch Upstream’, and click ‘Fetch and Merge’. You can also check the comparisons to check any changes made from the remote vs forked branch.<br /> <i>Note: Fetch Upstream only updates the current branch you fetched</i> <img src="../../../assets/images/delivery-kit/update-repository.png" alt="best-practices" /></p> </li> <li> <p>Once done, the build pipelines on DevOps will automatically update. You can check it on Azure DevOps as well, where the related repository is in the build pipeline.</p> </li> <li> <p>If the build goes successful, go to Releases branch and Create a release, and select the version you want to deploy. The steps can be found at <a href="https://github.dxc.com/WorkplaceAndMobility/DXC-MW-UPT/blob/R2-Delivery-Kit/content/Delivery-Kit/Installation%20and%20Configuration%20Guide/01%20Azure%20-%20Provision/01%20Azure%20DevOps.md">Azure DevOps</a> at section Releases, #4.</p> </li> </ol> <hr> <h2 class="text-delta">Table of contents</h2> <ul> </ul> </div> </div> <div class="search-overlay"></div> </div> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>
