<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>CICD Pipelines - Uptime Docs</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.3/dist/mermaid.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>CICD Pipelines | Uptime Docs</title> <meta name="generator" content="Jekyll v4.3.0" /> <meta property="og:title" content="CICD Pipelines" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Confluence for Uptime Support and Delivery" /> <meta property="og:description" content="Confluence for Uptime Support and Delivery" /> <link rel="canonical" href="https://just-the-docs.github.io/docs/Build-Kit/CICD%20Pipelines.html" /> <meta property="og:url" content="https://just-the-docs.github.io/docs/Build-Kit/CICD%20Pipelines.html" /> <meta property="og:site_name" content="Uptime Docs" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="CICD Pipelines" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Confluence for Uptime Support and Delivery","headline":"CICD Pipelines","url":"https://just-the-docs.github.io/docs/Build-Kit/CICD%20Pipelines.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Uptime Docs </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Build Kit category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/docs/Build-Kit" class="nav-list-link">Build Kit</a><ul class="nav-list "><li class="nav-list-item active"><a href="/docs/Build-Kit/CICD%20Pipelines.html" class="nav-list-link active">CICD Pipelines</a></li><li class="nav-list-item "><a href="/docs/Build-Kit/Data%20Protection%20Impact%20Assessment%20(DPIA).html" class="nav-list-link">Data Protection Impact Assessment (DPIA)</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Definition of Terms category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/docs/Definition-of-Terms" class="nav-list-link">Definition of Terms</a><ul class="nav-list "></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Delivery Kit category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/docs/Delivery-kit/" class="nav-list-link">Delivery Kit</a><ul class="nav-list "><li class="nav-list-item "><a href="#" class="nav-list-expander" aria-label="toggle links in Install and Configuration Guide category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/docs/Delivery-kit/Install%20and%20Configuration%20Guide" class="nav-list-link">Install and Configuration Guide</a><ul class="nav-list"><li class="nav-list-item "> <a href="/docs/Delivery-kit/Install%20and%20Configuration%20Guide/01%20Azure%20DevOps" class="nav-list-link">Azure DevOps</a> </li><li class="nav-list-item "> <a href="/docs/Delivery-kit/Install%20and%20Configuration%20Guide/02%20UPtime%20Portal/01%20Install%20Process.html" class="nav-list-link">UPtime Portal</a> </li></ul></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Uptime Docs" aria-label="Search Uptime Docs" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//uptime.dxc.com/" class="site-button" target="_blank" rel="noopener noreferrer" > DXCi Uptime </a> </li> <li class="aux-nav-list-item"> <a href="https:////uptime.digitaldemostudio.com/" class="site-button" target="_blank" rel="noopener noreferrer" > DXCi Showcase </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/docs/Build-Kit">Build Kit</a></li> <li class="breadcrumb-nav-list-item"><span>CICD Pipelines</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="general-application-cicd-overview"> <a href="#general-application-cicd-overview" class="anchor-heading" aria-labelledby="general-application-cicd-overview"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> General Application CI/CD Overview </h1> <p><strong>This document is being provided as a general reference and is not directly applicable to UPtime deployment and configuration procedures.</strong></p> <p><img src="../../assets/images/delivery-kit/overview.png" alt="image" />.</p> <h1 id="how-we-manage-source-code-for-release"> <a href="#how-we-manage-source-code-for-release" class="anchor-heading" aria-labelledby="how-we-manage-source-code-for-release"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How we manage source code for release </h1> <h2 id="github-work-flow"> <a href="#github-work-flow" class="anchor-heading" aria-labelledby="github-work-flow"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Github Work Flow </h2> <ul> <li>https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow <h3 id="develop-and-master-branches"> <a href="#develop-and-master-branches" class="anchor-heading" aria-labelledby="develop-and-master-branches"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Develop and Master Branches </h3> </li> <li>Instead of a single master branch, this workflow uses two branches to record the history of the project. The master branch stores the official release history, and the develop branch serves as an integration branch for features. It’s also convenient to tag all commits in the master branch with a version number.</li> </ul> <p><img src="../../assets/images/delivery-kit/master_develop.png" alt="Example" /></p> <h3 id="feature-branches"> <a href="#feature-branches" class="anchor-heading" aria-labelledby="feature-branches"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Feature Branches </h3> <ul> <li> <p>Each new feature should reside in its own branch, which can be pushed to the central repository for backup/collaboration. But, instead of branching off of master, feature branches use develop as their parent branch. When a feature is complete, it gets merged back into develop. Features should never interact directly with master.</p> </li> <li> <p>We suggest we should give the feature branch as JIRA ticket number, it will help us to manage them in the future</p> </li> <li> <p>When you’re done with the development work on the feature, the next step is to merge the feature_branch into develop.</p> </li> </ul> <p><img src="../../assets/images/delivery-kit/feature_branch.png" alt="Example" /></p> <h3 id="release-branches"> <a href="#release-branches" class="anchor-heading" aria-labelledby="release-branches"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Release Branches </h3> <ul> <li> <p>Once develop has acquired enough features for a release (or a predetermined release date is approaching), you fork a release branch off of develop. Creating this branch starts the next release cycle, so no new features can be added after this point—only bug fixes, documentation generation, and other release-oriented tasks should go in this branch. Once it’s ready to ship, the release branch gets merged into master and tagged with a version number. In addition, it should be merged back into develop, which may have progressed since the release was initiated.</p> </li> <li> <p>Using a dedicated branch to prepare releases makes it possible for one team to polish the current release while another team continues working on features for the next release. It also creates well-defined phases of development (e.g., it’s easy to say, “This week we’re preparing for version 4.0,” and to actually see it in the structure of the repository).</p> </li> </ul> <p><img src="../../assets/images/delivery-kit/release_branch.png" alt="Example" /></p> <h3 id="hotfix-branches"> <a href="#hotfix-branches" class="anchor-heading" aria-labelledby="hotfix-branches"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Hotfix Branches </h3> <ul> <li>Maintenance or “hotfix” branches are used to quickly patch production releases. Hotfix branches are a lot like release branches and feature branches except they’re based on master instead of develop. This is the only branch that should fork directly off of master. As soon as the fix is complete, it should be merged into both master and develop (or the current release branch), and master should be tagged with an updated version number.</li> </ul> <p><img src="../../assets/images/delivery-kit/hotfix_branch.png" alt="Example" /></p> <h1 id="azure-devops-variables-and-security"> <a href="#azure-devops-variables-and-security" class="anchor-heading" aria-labelledby="azure-devops-variables-and-security"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Azure DevOps Variables and Security </h1> <p>Variables give you a convenient way to get key bits of data into various parts of the pipeline. The most common use of variables is to define a value that you can then use in your pipeline. All variables are stored as strings and are mutable. The value of a variable can change from run to run or job to job of your pipeline.</p> <p>When you define the same variable in multiple places with the same name, the most locally scoped variable wins. So, a variable defined at the job level can override a variable set at the stage level. A variable defined at the stage level will override a variable set at the pipeline root level. A variable set in the pipeline root level will override a variable set in the Pipeline settings UI.</p> <p>Variables are different from runtime parameters, which are typed and available during template parsing.</p> <p>Use a variable group to store values that you want to control and make available across multiple pipelines. You can also use variable groups to store secrets and other values that might need to be passed into a YAML pipeline. Variable groups are defined and managed in the Library page under Pipelines.</p> <p>More information: https://docs.microsoft.com/en-us/azure/devops/pipelines/library/variable-groups?view=azure-devops&amp;tabs=classic</p> <h2 id="variable-scopes"> <a href="#variable-scopes" class="anchor-heading" aria-labelledby="variable-scopes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Variable scopes </h2> <p>In the YAML file, you can set a variable at various scopes:</p> <ul> <li>At the root level, to make it available to all jobs in the pipeline.</li> <li>At the stage level, to make it available only to a specific stage.</li> <li>At the job level, to make it available only to a specific job. When a variable is defined at the top of a YAML, it will be available to all jobs and stages in the pipeline and is a global variable. Global variables defined in a YAML are not visible in the pipeline settings UI.</li> </ul> <p>Variables at the job level override variables at the root and stage level. Variables at the stage level override variables at the root level.</p> <h2 id="access-variables-through-the-environment"> <a href="#access-variables-through-the-environment" class="anchor-heading" aria-labelledby="access-variables-through-the-environment"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Access variables through the environment </h2> <p>Notice that variables are also made available to scripts through environment variables. The syntax for using these environment variables depends on the scripting language.</p> <p>The name is upper-cased, and the . is replaced with the _. This is automatically inserted into the process environment. Here are some examples:</p> <ul> <li>Batch script: %VARIABLE_NAME%</li> <li>PowerShell script: $env:VARIABLE_NAME</li> <li>Bash script: $VARIABLE_NAME</li> </ul> <h2 id="set-secret-variables"> <a href="#set-secret-variables" class="anchor-heading" aria-labelledby="set-secret-variables"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Set secret variables </h2> <p>To set secrets in the web interface, follow these steps:</p> <ul> <li>Go to the Pipelines page, select the appropriate pipeline, and then select Edit.</li> <li>Locate the Variables for this pipeline.</li> <li>Add or update the variable.</li> <li>Select the Secret lock icon to store the variable in an encrypted manner.</li> <li>Save the pipeline.</li> <li>Secret variables are encrypted at rest with a 2048-bit RSA key. Secrets are available on the agent for tasks and scripts to use. Be careful about who has access to alter your pipeline.</li> </ul> <p>Unlike a normal variable, they are not automatically decrypted into environment variables for scripts. You need to explicitly map secret variables.</p> <h2 id="share-variables-across-pipelines"> <a href="#share-variables-across-pipelines" class="anchor-heading" aria-labelledby="share-variables-across-pipelines"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Share variables across pipelines </h2> <p>To share variables across multiple pipelines in your project, use the web interface. Under Library, use variable groups.</p> <p>More information: https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&amp;tabs=yaml%2Cbatch</p> <h1 id="terraform"> <a href="#terraform" class="anchor-heading" aria-labelledby="terraform"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Terraform </h1> <p>For the application we are using terraform to build and deploy the environments and components</p> <p>Prerequisites</p> <ul> <li>Terraform CLI: https://www.terraform.io/downloads.html ( for development environment)</li> <li>Azure Service Principle Key has Owner Permission on Subscription</li> <li>Has Access Rights to access Azure DevOps</li> <li>https://dev.azure.com/mwa-microservices/Microservices%20Capabilities Source Code and Build</li> <li>https://github.dxc.com/MWA/provision</li> <li>https://dev.azure.com/mwa-microservices/Microservices%20Capabilities/_release?_a=releases&amp;view=mine&amp;definitionId=1</li> </ul> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">variable "customer_name" {</span>
    <span class="s">default = "$(customer_name)"</span>
<span class="err">}</span>
<span class="s">variable "az_subscription" {</span>
    <span class="s">default = "$(az_subscription)"</span>
<span class="err">}</span>
<span class="s">variable "az_username" {</span>
    <span class="s">default = "$(az_username)"</span>
<span class="err">}</span>
<span class="s">variable "az_password" {</span>
    <span class="s">default = "$(az_password)"</span>
<span class="err">}</span>
<span class="s">variable "az_tenant" {</span>
    <span class="s">default = "$(az_tenant)"</span>
<span class="err">}</span>
<span class="s">variable "DOCKER_REGISTRY_SERVER_PASSWORD" {</span>
    <span class="s">default = "$(DOCKER_REGISTRY_SERVER_PASSWORD)"</span>
<span class="err">}</span>
<span class="s">variable "DOCKER_REGISTRY_SERVER_URL" {</span>
    <span class="s">default = "$(DOCKER_REGISTRY_SERVER_URL)"</span>
<span class="err">}</span>
<span class="s">variable "DOCKER_REGISTRY_SERVER_USERNAME" {</span>
    <span class="s">default = "$(DOCKER_REGISTRY_SERVER_USERNAME)"</span>
<span class="err">}</span>
<span class="s">variable "frontend_image" {</span>
    <span class="s">default = "$(frontend_image)"</span>
<span class="err">}</span>
<span class="s">variable "backend_image" {</span>
    <span class="s">default = "$(backend_image)"</span>
<span class="err">}</span>
<span class="s">variable "itsm_image" {</span>
    <span class="s">default = "$(itsm_image)"</span>
<span class="err">}</span>
<span class="s">variable "itsm_servicenow_image" {</span>
    <span class="s">default = "$(itsm_servicenow_image)"</span>
<span class="err">}</span>
<span class="s">variable "app_database_image" {</span>
    <span class="s">default = "$(app_database_image)"</span>
<span class="err">}</span>
<span class="s">variable "notification_image" {</span>
    <span class="s">default = "$(notification_image)"</span>
<span class="err">}</span>
<span class="s">variable "apim_sku_name" {</span>
    <span class="s">default = "$(apim_sku_name)"</span>
<span class="err">}</span>
<span class="s">variable "location" {</span>
    <span class="s">default = "$(location)"</span>
<span class="err">}</span>
<span class="s">variable "PDXC_API" {</span>
    <span class="s">default = "$(PDXC_API)"</span>
<span class="err">}</span>
<span class="s">variable "SNOW_PW" {</span>
    <span class="s">default = "$(SNOW_PW)"</span>
<span class="err">}</span>
<span class="s">variable "SNOW_URL" {</span>
    <span class="s">default = "$(SNOW_URL)"</span>
<span class="err">}</span>
<span class="s">variable "SNOW_USER" {</span>
    <span class="s">default = "$(SNOW_USER)"</span>
<span class="err">}</span>
<span class="s">variable "keyvault_name" {</span>
    <span class="s">default = "$(keyvaultName)"</span>
<span class="err">}</span>
<span class="s">variable "apim_name" {</span>
    <span class="s">default = "$(apim_name)"</span>
<span class="err">}</span>
<span class="s">variable "cdn_name" {</span>
    <span class="s">default = "$(cdn_name)"</span>
<span class="err">}</span>
<span class="s">variable "KB_ANNOUCEMENT_ENCODED_QUERY" {</span>
    <span class="s">default = "$(KB_ANNOUCEMENT_ENCODED_QUERY)"</span>
<span class="err">}</span>
<span class="s">variable "KB_FEATURED_ENCODED_QUERY" {</span>
    <span class="s">default = "$(KB_FEATURED_ENCODED_QUERY)"</span>
<span class="err">}</span>
<span class="s">variable "KB_TOP_ENCODED_QUERY" {</span>
    <span class="s">default = "$(KB_TOP_ENCODED_QUERY)"</span>
<span class="err">}</span>
<span class="s">variable "KB_ANNOUCEMENT_CONDITION" {</span>
    <span class="s">default = "$(KB_ANNOUCEMENT_CONDITION)"</span>
<span class="err">}</span>
<span class="s">variable "FIREBASE_ADMIN_AUTH" {</span>
     <span class="s">default = "$(FIREBASE_ADMIN_AUTH)"</span>
<span class="err">}</span>
<span class="s">variable "FIREBASE_ADMIN_ENDPOINT" {</span>
     <span class="s">default = "$(FIREBASE_ADMIN_ENDPOINT)"</span>
<span class="err">}</span>
<span class="s">variable "KB_BASE_IDS" {</span>
    <span class="s">default = "$(KB_BASE_IDS)"</span>
<span class="err">}</span>

</code></pre></div></div> <h2 id="deployment-patterns"> <a href="#deployment-patterns" class="anchor-heading" aria-labelledby="deployment-patterns"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Deployment Patterns: </h2> <ul> <li>$(name)-shared-resource (resource group) <ul> <li>$(name)-appservice-linux (appservice - https://azure.microsoft.com/en-us/services/app-service/)</li> <li>$(name)–application-insight ( application insight - https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview)</li> <li>tfsta (storage account- https://azure.microsoft.com/en-us/pricing/details/storage/)</li> <li>$(name)-apim $(name)-frontend (azure front door - https://azure.microsoft.com/en-us/services/frontdoor/)</li> <li>$(name)wafpolicy (WAF policy - https://docs.microsoft.com/en-us/azure/web-application-firewall/ag/policy-overview)</li> <li>$(name)-microservices-apim (api management - https://azure.microsoft.com/en-us/services/api-management/)</li> <li>$(name)-cosmos-db (https://azure.microsoft.com/en-us/services/cosmos-db/)</li> <li>$(name)-redis-cache (https://azure.microsoft.com/en-us/services/cache/)</li> <li>$(name)-srg (https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview)</li> <li>$(name)-vnet (https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview)</li> <li>$(name)-keyvault (https://azure.microsoft.com/en-us/services/key-vault/)</li> </ul> </li> <li>$(name)-frontend (resource group) <ul> <li>$(name)-frontend (webapp - https://azure.microsoft.com/en-us/services/app-service/web/)</li> </ul> </li> <li>$(name)-backend (resource group) <ul> <li>itsm-microservice (function app - https://azure.microsoft.com/en-us/services/functions/)</li> <li>itsm-servicenow-microservice (function app - https://azure.microsoft.com/en-us/services/functions/)</li> <li>app-database-microservice (function app - https://azure.microsoft.com/en-us/services/functions/)</li> </ul> </li> </ul> <h1 id="front-end-cicd"> <a href="#front-end-cicd" class="anchor-heading" aria-labelledby="front-end-cicd"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Front End CI/CD </h1> <h2 id="prerequisites"> <a href="#prerequisites" class="anchor-heading" aria-labelledby="prerequisites"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prerequisites </h2> <ul> <li>Azure Service Principle Key has Owner Permission on Subscription</li> <li>Has Access Rights to access Azure DevOps</li> <li>https://dev.azure.com/mwa-microservices/Microservices%20Capabilities</li> </ul> <h2 id="source-code-and-build"> <a href="#source-code-and-build" class="anchor-heading" aria-labelledby="source-code-and-build"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Source Code and Build </h2> <ul> <li>https://github.dxc.com/MWA/helix-frontend-webapp</li> <li>https://dev.azure.com/mwa-microservices/Microservices%20Capabilities/_build?definitionId=4</li> </ul> <h2 id="build-pipeline"> <a href="#build-pipeline" class="anchor-heading" aria-labelledby="build-pipeline"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build Pipeline: </h2> <p>For the latest version you can find in here https://github.dxc.com/MWA/helix-frontend-webapp/blob/develop/azure-pipelines.yml</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Vulnerability</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Scan vulnerability application</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">Npm_Vulnerability</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Npm Vulnerability</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Npm@1</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">npm install</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">install'</span>
        <span class="na">workingDir</span><span class="pi">:</span> <span class="s1">'</span><span class="s">azure/src'</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">CmdLine@2</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">npm audit</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">sudo npm install -g retire --unsafe-perm=true --allow-root</span>
          <span class="s">sudo npm install -g npm-audit-html --unsafe-perm=true --allow-root</span>
          <span class="s">npm audit --json | npm-audit-html</span>
          <span class="s">ls</span>
        <span class="na">workingDirectory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">azure/src'</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">CopyFiles@2</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Copy</span><span class="nv"> </span><span class="s">Files</span><span class="nv"> </span><span class="s">to:</span><span class="nv"> </span><span class="s">Copy</span><span class="nv"> </span><span class="s">Vulnerability</span><span class="nv"> </span><span class="s">Report'</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">SourceFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">./azure/src'</span>
        <span class="na">Contents</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">npm-audit.html</span>
          <span class="s">!node_modules/**</span>
        <span class="na">TargetFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)'</span>
        <span class="na">OverWrite</span><span class="pi">:</span> <span class="no">true</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">PublishBuildArtifacts@1</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">PathtoPublish</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)'</span>
        <span class="na">ArtifactName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">vulnerability-report'</span>
        <span class="na">publishLocation</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Container'</span>    
 
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Publish</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Publish Artifacts</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">publish</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Publish</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Docker@2</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">containerRegistry</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mwamicroservicesdev'</span>
        <span class="na">repository</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mwa-microservice/build/helix/helix-frontend'</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">buildAndPush'</span>
        <span class="na">Dockerfile</span><span class="pi">:</span> <span class="s1">'</span><span class="s">azure/src/Dockerfile'</span>
        <span class="na">tags</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.SourceBranchName).$(Build.BuildId)'</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">CopyFiles@2</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Copy</span><span class="nv"> </span><span class="s">Files</span><span class="nv"> </span><span class="s">to:</span><span class="nv"> </span><span class="s">Staging</span><span class="nv"> </span><span class="s">Artifact'</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">SourceFolder</span><span class="pi">:</span> <span class="s">./azure</span>
        <span class="na">TargetFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)'</span>
        <span class="na">OverWrite</span><span class="pi">:</span> <span class="no">true</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">PublishBuildArtifacts@1</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">PathtoPublish</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)'</span>
        <span class="na">ArtifactName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">uptime-frontend'</span>
        <span class="na">publishLocation</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Container'</span>
</code></pre></div></div> <h2 id="configuration-file"> <a href="#configuration-file" class="anchor-heading" aria-labelledby="configuration-file"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuration file </h2> <p>For some limitation in React we can’t set variables environment in azure webapp settings. We need to modify it before docker build step</p> <ul> <li>https://dev.azure.com/mwa-microservices/Microservices%20Capabilities/_release?_a=releases&amp;view=mine&amp;definitionId=8<pre><code class="language-txt">REACT_APP_AZURE_REG=$(REACT_APP_AZURE_REG)
REACT_APP_WEBSITE_NAME=$(REACT_APP_WEBSITE_NAME)
REACT_APP_OCP_APIM_URL=$(REACT_APP_OCP_APIM_URL)
REACT_APP_OCP_APIM_SUBSCRIPTION_KEY=$(REACT_APP_OCP_APIM_SUBSCRIPTION_KEY)
REACT_APP_APPINSIGHTS_INSTRUMENTATIONKEY=$(APPINSIGHTS_INSTRUMENTATIONKEY)
REACT_APP_OKTA_BASE_URL=$(REACT_APP_OKTA_BASE_URL)
REACT_APP_OKTA_CLIENTID=$(REACT_APP_OKTA_CLIENTID)
REACT_APP_OKTA_LOGO=$(REACT_APP_OKTA_LOGO)
REACT_APP_FIREBASE_APIKEY=$(REACT_APP_FIREBASE_APIKEY)
REACT_APP_FIREBASE_AUTHDOMAIN=$(REACT_APP_FIREBASE_AUTHDOMAIN)
REACT_APP_FIREBASE_PROJECTID=$(REACT_APP_FIREBASE_PROJECTID)
REACT_APP_FIREBASE_STORAGEBUCKET=$(REACT_APP_FIREBASE_STORAGEBUCKET)
REACT_APP_FIREBASE_MESSAGINGSENDERID=$(REACT_APP_FIREBASE_MESSAGINGSENDERID)
REACT_APP_FIREBASE_APPID=$(REACT_APP_FIREBASE_APPID)
REACT_APP_NOTIFICATION_OCP_APIM_URL=$(REACT_APP_NOTIFICATION_OCP_APIM_URL)
REACT_APP_NOTIFICATION_OCP_APIM_SUBSCRIPTION_KEY=$(REACT_APP_NOTIFICATION_OCP_APIM_SUBSCRIPTION_KEY)
</code></pre><h1 id="backend-cicd"> <a href="#backend-cicd" class="anchor-heading" aria-labelledby="backend-cicd"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Backend CI/CD </h1> <h2 id="itsm-cicd"> <a href="#itsm-cicd" class="anchor-heading" aria-labelledby="itsm-cicd"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ITSM CI/CD </h2> <h3 id="prerequisites-1"> <a href="#prerequisites-1" class="anchor-heading" aria-labelledby="prerequisites-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prerequisites </h3> </li> <li>Azure Service Principle Key has Owner Permission on Subscription</li> <li>Has Access Rights to access Azure DevOps</li> <li>https://dev.azure.com/mwa-microservices/Microservices%20Capabilities <h3 id="source-code-and-build-1"> <a href="#source-code-and-build-1" class="anchor-heading" aria-labelledby="source-code-and-build-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Source Code and Build </h3> </li> <li>https://github.dxc.com/MWA/ms-itsm</li> <li>https://dev.azure.com/mwa-microservices/Microservices%20Capabilities/_build?definitionId=8</li> <li>http://mwasonarqube.eastus2.cloudapp.azure.com/dashboard?id=build%3Ahelix-itsm-microservice</li> </ul> <h2 id="build-pipeline-1"> <a href="#build-pipeline-1" class="anchor-heading" aria-labelledby="build-pipeline-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build Pipeline: </h2> <p>For the latest version you can find in here https://github.dxc.com/MWA/ms-itsm/blob/develop/azure-pipelines.yml</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Starter pipeline</span>
<span class="c1"># Start with a minimal pipeline that you can customize to build and deploy your code.</span>
<span class="c1"># Add steps that build, run tests, deploy, and more:</span>
<span class="c1"># https://aka.ms/yaml</span>
 
<span class="na">trigger</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">master</span>
<span class="pi">-</span> <span class="s">develop</span>
<span class="pi">-</span> <span class="s">release/*</span>
 
<span class="na">pool</span><span class="pi">:</span>
  <span class="na">vmImage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ubuntu-20.04'</span>
 
<span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Build</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Build application</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">Build</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Nodejs Build</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Npm@1</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">npm install</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">install'</span>
        <span class="na">workingDir</span><span class="pi">:</span> <span class="s1">'</span><span class="s">azure/function'</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Code_Quality</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Scan Code Quality</span>
  <span class="na">condition</span><span class="pi">:</span> <span class="s">and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">Sonar</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Sonar</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">SonarQubePrepare@4</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">SonarQube</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mwasonarqube'</span>
        <span class="na">scannerMode</span><span class="pi">:</span> <span class="s1">'</span><span class="s">CLI'</span>
        <span class="na">configMode</span><span class="pi">:</span> <span class="s1">'</span><span class="s">manual'</span>
        <span class="na">cliProjectKey</span><span class="pi">:</span> <span class="s1">'</span><span class="s">build:helix-itsm-microservice'</span>
        <span class="na">cliProjectName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">build:helix-itsm-microservice'</span>
        <span class="na">cliProjectVersion</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.SourceBranchName)'</span>
        <span class="na">cliSources</span><span class="pi">:</span> <span class="s1">'</span><span class="s">.'</span>
        <span class="na">extraProperties</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s"># Additional properties that will be passed to the scanner,</span>
          <span class="s"># Put one key=value per line, example:</span>
          <span class="s"># sonar.exclusions=**/*.bin</span>
          <span class="s">sonar.coverage.exclusions = "**/server.js"</span>
 
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">SonarQubeAnalyze@4</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">SonarQubePublish@4</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">pollingTimeoutSec</span><span class="pi">:</span> <span class="s1">'</span><span class="s">300'</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Vulnerability</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Scan vulnerability application</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">Npm_Vulnerability</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Npm Vulnerability</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Npm@1</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">npm install</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">install'</span>
        <span class="na">workingDir</span><span class="pi">:</span> <span class="s1">'</span><span class="s">azure/function'</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">CmdLine@2</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">npm audit</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">sudo npm install -g retire --unsafe-perm=true --allow-root</span>
          <span class="s">sudo npm install -g npm-audit-html --unsafe-perm=true --allow-root</span>
          <span class="s">npm audit --json | npm-audit-html</span>
          <span class="s">ls</span>
        <span class="na">workingDirectory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">azure/function'</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">CopyFiles@2</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Copy</span><span class="nv"> </span><span class="s">Files</span><span class="nv"> </span><span class="s">to:</span><span class="nv"> </span><span class="s">Copy</span><span class="nv"> </span><span class="s">Vulnerability</span><span class="nv"> </span><span class="s">Report'</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">SourceFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">./azure/function'</span>
        <span class="na">Contents</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">npm-audit.html</span>
          <span class="s">!node_modules/**</span>
        <span class="na">TargetFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)'</span>
        <span class="na">OverWrite</span><span class="pi">:</span> <span class="no">true</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">PublishBuildArtifacts@1</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">PathtoPublish</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)'</span>
        <span class="na">ArtifactName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">vulnerability-report'</span>
        <span class="na">publishLocation</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Container'</span>    
 
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Publish</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Publish Artifacts</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">publish</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Publish</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">CopyFiles@2</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Copy</span><span class="nv"> </span><span class="s">Files</span><span class="nv"> </span><span class="s">to:</span><span class="nv"> </span><span class="s">Staging</span><span class="nv"> </span><span class="s">Artifact'</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">SourceFolder</span><span class="pi">:</span> <span class="s">./azure</span>
        <span class="na">TargetFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)'</span>
        <span class="na">OverWrite</span><span class="pi">:</span> <span class="no">true</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">PublishBuildArtifacts@1</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">PathtoPublish</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)'</span>
        <span class="na">ArtifactName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">helix-itsm-microservice'</span>
        <span class="na">publishLocation</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Container'</span>
</code></pre></div></div> <h3 id="terraform-template"> <a href="#terraform-template" class="anchor-heading" aria-labelledby="terraform-template"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Terraform Template </h3> <p>The latest version you can find in here https://github.dxc.com/MWA/provision/blob/master/usecase/helix/main.tf</p><pre><code class="language-txt">resource "azurerm_resource_group" "itsm_beg" {
  name     = "${var.customer_name}-backend"
  location = "${var.location }"
}

resource "azurerm_function_app" "itsm_beg" {
  name                      = "${var.customer_name}-itsm-microservice"
  location                  = azurerm_resource_group.itsm_beg.location
  resource_group_name       = azurerm_resource_group.itsm_beg.name
  app_service_plan_id       = azurerm_app_service_plan.srg.id
  storage_account_name      = azurerm_storage_account.srg.name
  storage_account_access_key = azurerm_storage_account.srg.primary_access_key
  os_type                    = "linux"
  https_only = true
  site_config {
    always_on        = true
    linux_fx_version   = "DOCKER|${var.itsm_image}"
  }
  app_settings = {
    DOCKER_REGISTRY_SERVER_PASSWORD = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.DOCKER_REGISTRY_SERVER_PASSWORD.versionless_id}/${azurerm_key_vault_secret.DOCKER_REGISTRY_SERVER_PASSWORD.version})"
    DOCKER_REGISTRY_SERVER_URL      = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.DOCKER_REGISTRY_SERVER_URL.versionless_id}/${azurerm_key_vault_secret.DOCKER_REGISTRY_SERVER_URL.version})"
    DOCKER_REGISTRY_SERVER_USERNAME = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.DOCKER_REGISTRY_SERVER_USERNAME.versionless_id}/${azurerm_key_vault_secret.DOCKER_REGISTRY_SERVER_USERNAME.version})"
    APPINSIGHTS_INSTRUMENTATIONKEY = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.APPINSIGHTS_INSTRUMENTATIONKEY.versionless_id}/${azurerm_key_vault_secret.APPINSIGHTS_INSTRUMENTATIONKEY.version})"
    APPLICATIONINSIGHTS_CONNECTION_STRING =  "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.APPLICATIONINSIGHTS_CONNECTION_STRING.versionless_id}/${azurerm_key_vault_secret.APPLICATIONINSIGHTS_CONNECTION_STRING.version})"
    ITSM_SERVICENOW                 = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.ITSM_SERVICENOW.versionless_id}/${azurerm_key_vault_secret.ITSM_SERVICENOW.version})"
    DB_API                          = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.DB_API.versionless_id}/${azurerm_key_vault_secret.DB_API.version})"
    REDISCACHEHOSTNAME = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.REDISCACHEHOSTNAME.versionless_id}/${azurerm_key_vault_secret.REDISCACHEHOSTNAME.version})"
    REDISCACHEKEY = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.REDISCACHEKEY.versionless_id}/${azurerm_key_vault_secret.REDISCACHEKEY.version})"
    AZURE_STORAGE = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.AZURE_STORAGE.versionless_id}/${azurerm_key_vault_secret.AZURE_STORAGE.version})"
    WEBSITE_ENABLE_SYNC_UPDATE_SITE = true
    WEBSITES_ENABLE_APP_SERVICE_STORAGE  = false
  }
}
</code></pre><h2 id="itsm-servicenow-cicd"> <a href="#itsm-servicenow-cicd" class="anchor-heading" aria-labelledby="itsm-servicenow-cicd"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ITSM-Servicenow CI/CD </h2> <h3 id="prerequisites-2"> <a href="#prerequisites-2" class="anchor-heading" aria-labelledby="prerequisites-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prerequisites </h3> <ul> <li>Azure Service Principle Key has Owner Permission on Subscription</li> <li>Has Access Rights to access Azure DevOps</li> <li>https://dev.azure.com/mwa-microservices/Microservices%20Capabilities <h3 id="source-code-and-build-2"> <a href="#source-code-and-build-2" class="anchor-heading" aria-labelledby="source-code-and-build-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Source Code and Build </h3> </li> <li>https://github.dxc.com/MWA/ms-itsm-servicenow</li> <li>https://dev.azure.com/mwa-microservices/Microservices%20Capabilities/_build?definitionId=9</li> <li>http://mwasonarqube.eastus2.cloudapp.azure.com/dashboard?id=build%3Ahelix-itsm-servicenow-microservice</li> </ul> <h2 id="build-pipeline-2"> <a href="#build-pipeline-2" class="anchor-heading" aria-labelledby="build-pipeline-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build Pipeline: </h2> <p>For the latest version you can find in here https://github.dxc.com/MWA/ms-itsm-servicenow/blob/develop/azure-pipelines.yml</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Starter pipeline</span>
<span class="c1"># Start with a minimal pipeline that you can customize to build and deploy your code.</span>
<span class="c1"># Add steps that build, run tests, deploy, and more:</span>
<span class="c1"># https://aka.ms/yaml</span>
 
<span class="na">trigger</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">master</span>
<span class="pi">-</span> <span class="s">develop</span>
<span class="pi">-</span> <span class="s">feature/*</span>
<span class="pi">-</span> <span class="s">release/*</span>
 
<span class="na">pool</span><span class="pi">:</span>
  <span class="na">vmImage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ubuntu-20.04'</span>
 
<span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Build</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Build application</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">Build</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Nodejs Build</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Npm@1</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">npm install</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">install'</span>
        <span class="na">workingDir</span><span class="pi">:</span> <span class="s1">'</span><span class="s">azure/function'</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Code_Quality</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Scan Code Quality</span>
  <span class="na">condition</span><span class="pi">:</span> <span class="s">and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">Sonar</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Sonar</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">SonarQubePrepare@4</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">SonarQube</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mwasonarqube'</span>
        <span class="na">scannerMode</span><span class="pi">:</span> <span class="s1">'</span><span class="s">CLI'</span>
        <span class="na">configMode</span><span class="pi">:</span> <span class="s1">'</span><span class="s">manual'</span>
        <span class="na">cliProjectKey</span><span class="pi">:</span> <span class="s1">'</span><span class="s">build:helix-itsm-servicenow-microservice'</span>
        <span class="na">cliProjectName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">build:helix-itsm-servicenow-microservice'</span>
        <span class="na">cliProjectVersion</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.SourceBranchName)'</span>
        <span class="na">cliSources</span><span class="pi">:</span> <span class="s1">'</span><span class="s">.'</span>
        <span class="na">extraProperties</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s"># Additional properties that will be passed to the scanner,</span>
          <span class="s"># Put one key=value per line, example:</span>
          <span class="s"># sonar.exclusions=**/*.bin</span>
          <span class="s">sonar.coverage.exclusions = "**/server.js"</span>
 
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">SonarQubeAnalyze@4</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">SonarQubePublish@4</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">pollingTimeoutSec</span><span class="pi">:</span> <span class="s1">'</span><span class="s">300'</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Vulnerability</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Scan vulnerability application</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">Npm_Vulnerability</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Npm Vulnerability</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Npm@1</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">npm install</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">install'</span>
        <span class="na">workingDir</span><span class="pi">:</span> <span class="s1">'</span><span class="s">azure/function'</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">CmdLine@2</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">npm audit</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">sudo npm install -g retire --unsafe-perm=true --allow-root</span>
          <span class="s">sudo npm install -g npm-audit-html --unsafe-perm=true --allow-root</span>
          <span class="s">npm audit --json | npm-audit-html</span>
          <span class="s">ls</span>
        <span class="na">workingDirectory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">azure/function'</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">CopyFiles@2</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Copy</span><span class="nv"> </span><span class="s">Files</span><span class="nv"> </span><span class="s">to:</span><span class="nv"> </span><span class="s">Copy</span><span class="nv"> </span><span class="s">Vulnerability</span><span class="nv"> </span><span class="s">Report'</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">SourceFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">./azure/function'</span>
        <span class="na">Contents</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">npm-audit.html</span>
          <span class="s">!node_modules/**</span>
        <span class="na">TargetFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)'</span>
        <span class="na">OverWrite</span><span class="pi">:</span> <span class="no">true</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">PublishBuildArtifacts@1</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">PathtoPublish</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)'</span>
        <span class="na">ArtifactName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">vulnerability-report'</span>
        <span class="na">publishLocation</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Container'</span>    
 
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Publish</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Publish Artifacts</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">publish</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Publish</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">CopyFiles@2</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Copy</span><span class="nv"> </span><span class="s">Files</span><span class="nv"> </span><span class="s">to:</span><span class="nv"> </span><span class="s">Staging</span><span class="nv"> </span><span class="s">Artifact'</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">SourceFolder</span><span class="pi">:</span> <span class="s">./azure</span>
        <span class="na">TargetFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)'</span>
        <span class="na">OverWrite</span><span class="pi">:</span> <span class="no">true</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">PublishBuildArtifacts@1</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">PathtoPublish</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)'</span>
        <span class="na">ArtifactName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">helix-itsm-servicenow-microservice'</span>
        <span class="na">publishLocation</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Container'</span>
</code></pre></div></div> <h3 id="terraform-template-1"> <a href="#terraform-template-1" class="anchor-heading" aria-labelledby="terraform-template-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Terraform Template </h3> <p>The latest version you can find in here https://github.dxc.com/MWA/provision/blob/master/usecase/helix/main.tf</p><pre><code class="language-txt">resource "azurerm_resource_group" "itsm_servicenow_beg" {
  name     = "${var.customer_name}-backend"
  location = "${var.location }"
}

resource "azurerm_function_app" "itsm_servicenow_beg" {
  name                      = "${var.customer_name}-itsm-servicenow-microservice"
  location                  = azurerm_resource_group.itsm_servicenow_beg.location
  resource_group_name       = azurerm_resource_group.itsm_servicenow_beg.name
  app_service_plan_id       = azurerm_app_service_plan.srg.id
  storage_account_name      = azurerm_storage_account.srg.name
  storage_account_access_key = azurerm_storage_account.srg.primary_access_key
  os_type                    = "linux"
  https_only = true
  version                    = "~3"
  identity {
    type = "SystemAssigned"
  }
  site_config {
    always_on        = true
    linux_fx_version   = "DOCKER|${var.itsm_servicenow_image}"
  }
  app_settings = {
    DOCKER_REGISTRY_SERVER_PASSWORD = "${var.DOCKER_REGISTRY_SERVER_PASSWORD}"
    DOCKER_REGISTRY_SERVER_URL      = "${var.DOCKER_REGISTRY_SERVER_URL}"
    DOCKER_REGISTRY_SERVER_USERNAME = "${var.DOCKER_REGISTRY_SERVER_USERNAME}"
    APPINSIGHTS_INSTRUMENTATIONKEY = azurerm_application_insights.srg.instrumentation_key
    APPLICATIONINSIGHTS_CONNECTION_STRING =  azurerm_application_insights.srg.connection_string
    SNOW_URL  = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.SNOW_URL.versionless_id}/${azurerm_key_vault_secret.SNOW_URL.version})"
    SNOW_USER = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.SNOW_USER.versionless_id}/${azurerm_key_vault_secret.SNOW_USER.version})"
    SNOW_PW = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.SNOW_PW.versionless_id}/${azurerm_key_vault_secret.SNOW_PW.version})"
    CONNECTNOW_INBOUND  = "api/mpsc/connectnow/inbound"
    PDXC_INTEGRATION  = true
    KB_BASE_IDS = "${var.KB_BASE_IDS}"
    FE_KB_URL_TEMPLATE = "https://${var.customer_name}-frontend.azurefd.net/knowledges/detail/{KB_NUMBER}"
    PDXC_API = "${var.PDXC_API}"
    KB_CONTENT_TEXT_LIMIT = "200"
    PDXC_API_TABLE_URL = "{\"INCIDENT\":\"inc1-dev\",\"REQUEST\":\"req1-dev\"}"
    KB_ANNOUCEMENT_ENCODED_QUERY = "${var.KB_ANNOUCEMENT_ENCODED_QUERY}"
    KB_TOP_ENCODED_QUERY = "${var.KB_TOP_ENCODED_QUERY}"
    KB_FEATURED_ENCODED_QUERY = "${var.KB_FEATURED_ENCODED_QUERY}"
    KB_ANNOUCEMENT_CONDITION = "${var.KB_ANNOUCEMENT_CONDITION}"
    WEBSITE_ENABLE_SYNC_UPDATE_SITE = true
    WEBSITES_ENABLE_APP_SERVICE_STORAGE  = false
  }
}
</code></pre><h2 id="app-database-cicd"> <a href="#app-database-cicd" class="anchor-heading" aria-labelledby="app-database-cicd"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> App-database CI/CD </h2> <h3 id="prerequisites-3"> <a href="#prerequisites-3" class="anchor-heading" aria-labelledby="prerequisites-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prerequisites </h3> <ul> <li>Azure Service Principle Key has Owner Permission on Subscription</li> <li>Has Access Rights to access Azure DevOps</li> <li>https://dev.azure.com/mwa-microservices/Microservices%20Capabilities <h3 id="source-code-and-build-3"> <a href="#source-code-and-build-3" class="anchor-heading" aria-labelledby="source-code-and-build-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Source Code and Build </h3> </li> <li>https://github.dxc.com/MWA/ms-app-database</li> <li>https://dev.azure.com/mwa-microservices/Microservices%20Capabilities/_build?definitionId=10 <h2 id="build-pipeline-3"> <a href="#build-pipeline-3" class="anchor-heading" aria-labelledby="build-pipeline-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build Pipeline: </h2> <p>For the latest version you can find in here https://github.dxc.com/MWA/ms-app-database/blob/develop/azure-pipelines.yml ```yaml resource “azurerm_resource_group” “cosmos_app_database_beg” { name = “${var.customer_name}-backend” location = “${var.location }” }</p> </li> </ul> <p>resource “azurerm_function_app” “cosmos_app_database_beg” { name = “${var.customer_name}-app-database-microservice” location = azurerm_resource_group.cosmos_app_database_beg.location resource_group_name = azurerm_resource_group.cosmos_app_database_beg.name app_service_plan_id = azurerm_app_service_plan.srg.id storage_account_name = azurerm_storage_account.srg.name storage_account_access_key = azurerm_storage_account.srg.primary_access_key os_type = “linux” https_only = true version = “~3” identity { type = “SystemAssigned” } site_config { always_on = true linux_fx_version = “DOCKER|${var.app_database_image}” } app_settings = { DOCKER_REGISTRY_SERVER_PASSWORD = “${var.DOCKER_REGISTRY_SERVER_PASSWORD}” DOCKER_REGISTRY_SERVER_URL = “${var.DOCKER_REGISTRY_SERVER_URL}” DOCKER_REGISTRY_SERVER_USERNAME = “${var.DOCKER_REGISTRY_SERVER_USERNAME}” APPINSIGHTS_INSTRUMENTATIONKEY = azurerm_application_insights.srg.instrumentation_key APPLICATIONINSIGHTS_CONNECTION_STRING = azurerm_application_insights.srg.connection_string HOST = “@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.HOST.versionless_id}/${azurerm_key_vault_secret.HOST.version})” AUTH_KEY = “@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.AUTH_KEY.versionless_id}/${azurerm_key_vault_secret.AUTH_KEY.version})” DATABASE_ID = “@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.DATABASE_ID.versionless_id}/${azurerm_key_vault_secret.DATABASE_ID.version})” DATABASE_CONNECTION = “@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.DATABASE_CONNECTION.versionless_id}/${azurerm_key_vault_secret.DATABASE_CONNECTION.version})” ITSM_SERVICES_API = “@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.ITSM_SERVICES_API.versionless_id}/${azurerm_key_vault_secret.ITSM_SERVICES_API.version})” WEBSITE_ENABLE_SYNC_UPDATE_SITE = true WEBSITES_ENABLE_APP_SERVICE_STORAGE = false } }</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Notification CI/CD
### Prerequisites 
- Azure Service Principle Key has Owner Permission on Subscription
- Has Access Rights to access Azure DevOps
- https://dev.azure.com/mwa-microservices/Microservices%20Capabilities
### Source Code and Build
- https://github.dxc.com/MWA/ms-notification
- https://dev.azure.com/mwa-microservices/Microservices%20Capabilities/_build?definitionId=12
## Build Pipeline:
For the latest version you can find in here https://github.dxc.com/MWA/ms-notification/blob/develop/azure-pipelines.yml
```yaml
resource "azurerm_resource_group" "notification_beg" {
  name     = "${var.customer_name}-backend"
  location = "${var.location }"
}

resource "azurerm_function_app" "notification_beg" {
  name                      = "${var.customer_name}-notification-microservice"
  location                  = azurerm_resource_group.notification_beg.location
  resource_group_name       = azurerm_resource_group.notification_beg.name
  app_service_plan_id       = azurerm_app_service_plan.srg.id
  storage_account_name      = azurerm_storage_account.srg.name
  storage_account_access_key = azurerm_storage_account.srg.primary_access_key
  os_type                    = "linux"
  https_only = true
  version                    = "~3"
  identity {
    type = "SystemAssigned"
  }
  site_config {
    always_on        = true
    linux_fx_version   = "DOCKER|${var.notification_image}"
  }
  app_settings = {
    DOCKER_REGISTRY_SERVER_PASSWORD = "${var.DOCKER_REGISTRY_SERVER_PASSWORD}"
    DOCKER_REGISTRY_SERVER_URL      = "${var.DOCKER_REGISTRY_SERVER_URL}"
    DOCKER_REGISTRY_SERVER_USERNAME = "${var.DOCKER_REGISTRY_SERVER_USERNAME}"
    APPINSIGHTS_INSTRUMENTATIONKEY = azurerm_application_insights.srg.instrumentation_key
    APPLICATIONINSIGHTS_CONNECTION_STRING =  azurerm_application_insights.srg.connection_string
    DB_API                          = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.DB_API.versionless_id}/${azurerm_key_vault_secret.DB_API.version})"
    FIREBASE_ADMIN_AUTH = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.FIREBASE_ADMIN_AUTH.versionless_id}/${azurerm_key_vault_secret.FIREBASE_ADMIN_AUTH.version})"
    FIREBASE_ADMIN_ENDPOINT = "@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.FIREBASE_ADMIN_ENDPOINT.versionless_id}/${azurerm_key_vault_secret.FIREBASE_ADMIN_ENDPOINT.version})"
    AZURE_SERVICEBUS_CONNECTIONSTRING ="@Microsoft.KeyVault(SecretUri=${azurerm_key_vault_secret.AZURE_SERVICEBUS_CONNECTIONSTRING.versionless_id}/${azurerm_key_vault_secret.AZURE_SERVICEBUS_CONNECTIONSTRING.version})"
    WEBPUSH_TOPIC = "${var.customer_name}-topic"
    WEBPUSH_SUBSCRIPTION = "notification"
    WEBSITE_ENABLE_SYNC_UPDATE_SITE = true
    WEBSITES_ENABLE_APP_SERVICE_STORAGE  = false
  }
}
</code></pre></div></div> <h1 id="azure-api-magement"> <a href="#azure-api-magement" class="anchor-heading" aria-labelledby="azure-api-magement"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Azure API Magement </h1> <p>For each of microservices we will publish api to API management by using the swagger</p> <ul> <li>https://github.dxc.com/MWA/ms-app-database/blob/develop/azure/apim/swagger.json</li> <li>https://github.dxc.com/MWA/ms-itsm/blob/develop/azure/apim/swagger.json</li> <li>https://github.dxc.com/MWA/ms-itsm-servicenow/blob/develop/azure/apim/swagger.json</li> </ul> <h1 id="azure-keyvault"> <a href="#azure-keyvault" class="anchor-heading" aria-labelledby="azure-keyvault"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Azure KeyVault </h1> <p>Azure Key Vault is a cloud service for securely storing and accessing secrets. A secret is anything that you want to tightly control access to, such as API keys, passwords, certificates, or cryptographic keys. Key Vault service supports two types of containers: vaults and managed hardware security module(HSM) pools. Vaults support storing software and HSM-backed keys, secrets, and certificates. Managed HSM pools only support HSM-backed keys.</p> <p>To do any operations with Key Vault, you first need to authenticate to it. There are three ways to authenticate to Key Vault:</p> <ul> <li> <p>Managed identities for Azure resources: When you deploy an app on a virtual machine in Azure, you can assign an identity to your virtual machine that has access to Key Vault. You can also assign identities to other Azure resources. The benefit of this approach is that the app or service isn’t managing the rotation of the first secret. Azure automatically rotates the identity. We recommend this approach as a best practice.</p> </li> <li> <p>Service principal and certificate: You can use a service principal and an associated certificate that has access to Key Vault. We don’t recommend this approach because the application owner or developer must rotate the certificate.</p> </li> <li> <p>Service principal and secret: Although you can use a service principal and a secret to authenticate to Key Vault, we don’t recommend it. It’s hard to automatically rotate the bootstrap secret that’s used to authenticate to Key Vault.</p> </li> </ul> <h2 id="azure-security-baseline-for-key-vault"> <a href="#azure-security-baseline-for-key-vault" class="anchor-heading" aria-labelledby="azure-security-baseline-for-key-vault"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Azure security baseline for Key Vault </h2> <p>https://docs.microsoft.com/en-us/security/benchmark/azure/baselines/key-vault-security-baseline</p> <h2 id="add-new-key-vault-secret-using-terraform"> <a href="#add-new-key-vault-secret-using-terraform" class="anchor-heading" aria-labelledby="add-new-key-vault-secret-using-terraform"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Add new key vault secret using Terraform </h2> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">resource "azurerm_key_vault_secret" "example" {</span>
  <span class="s">name         = "secret-sauce"</span>
  <span class="s">value        = "szechuan"</span>
  <span class="s">key_vault_id = azurerm_key_vault.example.id</span>
<span class="err">}</span>
</code></pre></div></div> <p>https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault_secret</p> <h2 id="custom-configuration-for-keyvault"> <a href="#custom-configuration-for-keyvault" class="anchor-heading" aria-labelledby="custom-configuration-for-keyvault"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Custom Configuration For KeyVault </h2> <p>https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault</p> <h2 id="current-keyvault"> <a href="#current-keyvault" class="anchor-heading" aria-labelledby="current-keyvault"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Current Keyvault </h2> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">resource "azurerm_redis_cache" "redis" {</span>
  <span class="s">name                = "${var.customer_name}-redis-cache"</span>
  <span class="s">location            = azurerm_resource_group.srg.location</span>
  <span class="s">resource_group_name = azurerm_resource_group.srg.name</span>
  <span class="s">capacity            = </span><span class="m">0</span>
  <span class="s">family              = "C"</span>
  <span class="s">sku_name            = "Basic"</span>
  <span class="s">enable_non_ssl_port = </span><span class="no">false</span>
  <span class="s">minimum_tls_version = "1.2"</span>

  <span class="s">redis_configuration {</span>
  <span class="s">}</span>
<span class="err">}</span>
<span class="s">resource "azurerm_cdn_profile" "cdn" {</span>
  <span class="s">name                = "${var.cdn_name}"</span>
  <span class="s">location            = azurerm_resource_group.srg.location</span>
  <span class="s">resource_group_name = azurerm_resource_group.srg.name</span>
  <span class="s">sku                 = "Standard_Akamai"</span>
<span class="err">}</span>

<span class="s">resource "azurerm_cdn_endpoint" "cdn" {</span>
  <span class="s">name                = "${var.cdn_name}"</span>
  <span class="s">profile_name        = azurerm_cdn_profile.cdn.name</span>
  <span class="s">location            = azurerm_resource_group.srg.location</span>
  <span class="s">resource_group_name = azurerm_resource_group.srg.name</span>

  <span class="s">origin {</span>
    <span class="s">name      = "${var.cdn_name}"</span>
    <span class="s">host_name = "${azurerm_storage_account.srg.name}.blob.core.windows.net"</span>
  <span class="s">}</span>
  <span class="s">origin_host_header = "${azurerm_storage_account.srg.name}.blob.core.windows.net"</span>
<span class="err">}</span>

<span class="s">resource "azurerm_cdn_endpoint" "frontend" {</span>
  <span class="s">name                = "${var.customer_name}-frontend"</span>
  <span class="s">profile_name        = azurerm_cdn_profile.cdn.name</span>
  <span class="s">location            = azurerm_resource_group.srg.location</span>
  <span class="s">resource_group_name = azurerm_resource_group.srg.name</span>

  <span class="s">origin {</span>
    <span class="s">name      = "${var.customer_name}-frontend"</span>
    <span class="s">host_name = "${var.customer_name}-frontend.azurefd.net"</span>
  <span class="s">}</span>
  <span class="s">origin_host_header = "${var.customer_name}-frontend.azurefd.net"</span>
<span class="err">}</span>

<span class="s">//key vault</span>
<span class="s">data "azurerm_client_config" "current" {}</span>
<span class="s">resource "azurerm_key_vault" "srg" {</span>
  <span class="s">name                        = "${var.keyvault_name}"</span>
  <span class="s">location                    = azurerm_resource_group.srg.location</span>
  <span class="s">resource_group_name         = azurerm_resource_group.srg.name</span>
  <span class="s">enabled_for_disk_encryption = </span><span class="no">true</span>
  <span class="s">tenant_id                   = data.azurerm_client_config.current.tenant_id</span>
  <span class="s">purge_protection_enabled    = </span><span class="no">false</span>
  <span class="s">soft_delete_retention_days  = </span><span class="m">7</span>
  <span class="s">sku_name = "standard"</span>
  <span class="s">access_policy {</span>
    <span class="s">tenant_id = data.azurerm_client_config.current.tenant_id</span>
    <span class="s">object_id = data.azurerm_client_config.current.object_id</span>

    <span class="s">secret_permissions = [</span>
      <span class="s">"Get", "Set", "List", "Delete"</span>
    <span class="s">]</span>

    <span class="s">storage_permissions = [</span>
      <span class="s">"Get",</span>
    <span class="s">]</span>
  <span class="s">}</span>
<span class="err">}</span>
<span class="s">//shared resource keyvault</span>
<span class="s">resource "azurerm_key_vault_secret" "DOCKER_REGISTRY_SERVER_PASSWORD" {</span>
  <span class="s">name         = "DOCKER-REGISTRY-SERVER-PASSWORD"</span>
  <span class="s">value        = "${var.DOCKER_REGISTRY_SERVER_PASSWORD}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "DOCKER_REGISTRY_SERVER_URL" {</span>
  <span class="s">name         = "DOCKER-REGISTRY-SERVER-URL"</span>
  <span class="s">value        = "${var.DOCKER_REGISTRY_SERVER_URL}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "DOCKER_REGISTRY_SERVER_USERNAME" {</span>
  <span class="s">name         = "DOCKER-REGISTRY-SERVER-USERNAME"</span>
  <span class="s">value        = "${var.DOCKER_REGISTRY_SERVER_USERNAME}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "APPINSIGHTS_INSTRUMENTATIONKEY" {</span>
  <span class="s">name         = "APPINSIGHTS-INSTRUMENTATIONKEY"</span>
  <span class="s">value        = azurerm_application_insights.srg.instrumentation_key</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "APPLICATIONINSIGHTS_CONNECTION_STRING" {</span>
  <span class="s">name         = "APPLICATIONINSIGHTS-CONNECTION-STRING"</span>
  <span class="s">value        = azurerm_application_insights.srg.connection_string</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "AzureWebJobsStorage" {</span>
  <span class="s">name         = "AzureWebJobsStorage"</span>
  <span class="s">value        = azurerm_storage_account.srg.primary_connection_string</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "Subscription_Key" {</span>
  <span class="s">name         = "SubscriptionKey"</span>
  <span class="s">value        = azurerm_api_management_subscription.subscription.primary_key</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">//itsm servicenow keyvault</span>
<span class="s">resource "azurerm_key_vault_secret" "CONNECTNOW_INBOUND" {</span>
  <span class="s">name         = "CONNECTNOW-INBOUND"</span>
  <span class="s">value        = "api/mpsc/connectnow/inbound"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "PDXC_INTEGRATION" {</span>
  <span class="s">name         = "PDXC-INTEGRATION"</span>
  <span class="s">value        = "true"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "KB_BASE_IDS" {</span>
  <span class="s">name         = "KB-BASE-IDS"</span>
  <span class="s">value        = "${var.KB_BASE_IDS}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "FE_KB_URL_TEMPLATE" {</span>
  <span class="s">name         = "FE-KB-URL-TEMPLATE"</span>
  <span class="s">value        = "https://${var.customer_name}-frontend.azurefd.net/knowledges/detail/{KB_NUMBER}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "PDXC_API" {</span>
  <span class="s">name         = "PDXC-API"</span>
  <span class="s">value        = "${var.PDXC_API}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "KB_CONTENT_TEXT_LIMIT" {</span>
  <span class="s">name         = "KB-CONTENT-TEXT-LIMIT"</span>
  <span class="s">value        = "200"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "PDXC_API_TABLE_URL" {</span>
  <span class="s">name         = "PDXC-API-TABLE-URL"</span>
  <span class="s">value        = "{\"INCIDENT\":\"inc1-dev\",\"REQUEST\":\"req1-dev\"}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "KB_ANNOUCEMENT_ENCODED_QUERY" {</span>
  <span class="s">name         = "KB-ANNOUCEMENT-ENCODED-QUERY"</span>
  <span class="s">value        = "${var.KB_ANNOUCEMENT_ENCODED_QUERY}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "KB_TOP_ENCODED_QUERY" {</span>
  <span class="s">name         = "KB-TOP-ENCODED-QUERY"</span>
  <span class="s">value        = "${var.KB_TOP_ENCODED_QUERY}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "KB_FEATURED_ENCODED_QUERY" {</span>
  <span class="s">name         = "KB-FEATURED-ENCODED-QUERY"</span>
  <span class="s">value        = "${var.KB_FEATURED_ENCODED_QUERY}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "SNOW_URL" {</span>
  <span class="s">name         = "ITSM-SNOW-URL"</span>
  <span class="s">value        = "${var.SNOW_URL}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "SNOW_PW" {</span>
  <span class="s">name         = "ITSM-SNOW-PW"</span>
  <span class="s">value        = "${var.SNOW_PW}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "SNOW_USER" {</span>
  <span class="s">name         = "ITSM-SNOW-USER"</span>
  <span class="s">value        = "${var.SNOW_USER}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">//app-database</span>
<span class="s">resource "azurerm_key_vault_secret" "HOST" {</span>
  <span class="s">name         = "HOST"</span>
  <span class="s">value        = azurerm_cosmosdb_account.db.endpoint</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "AUTH_KEY" {</span>
  <span class="s">name         = "AUTH-KEY"</span>
  <span class="s">value        = azurerm_cosmosdb_account.db.primary_key</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "DATABASE_ID" {</span>
  <span class="s">name         = "DATABASE-ID"</span>
  <span class="s">value        = "helix-app"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "DATABASE_CONNECTION" {</span>
  <span class="s">name         = "DATABASE-CONNECTION"</span>
  <span class="s">value        = azurerm_cosmosdb_account.db.connection_strings[0]</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "ITSM_SERVICES_API" {</span>
  <span class="s">name         = "ITSM-SERVICES-API"</span>
  <span class="s">value        = "{\"url\"</span><span class="err">:</span> <span class="s">\"https://${var.customer_name}-apim.azurefd.net/${var.customer_name}-itsm-microservice/api\", \"header_key\":\"ocp-apim-subscription-key\", \"header_value\"</span><span class="err">:</span> <span class="s">\"${azurerm_api_management_subscription.subscription.primary_key}\"}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">//itsm</span>
<span class="s">resource "azurerm_key_vault_secret" "ITSM_SERVICENOW" {</span>
  <span class="s">name         = "ITSM-SERVICENOW"</span>
  <span class="s">value        = "{\"url\"</span><span class="err">:</span> <span class="s">\"https://${var.customer_name}-apim.azurefd.net/${var.customer_name}-itsm-servicenow-microservice\", \"header_key\":\"ocp-apim-subscription-key\", \"header_value\"</span><span class="err">:</span> <span class="s">\"${azurerm_api_management_subscription.subscription.primary_key}\"}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "DB_API" {</span>
  <span class="s">name         = "DB-API"</span>
  <span class="s">value        = "{\"url\"</span><span class="err">:</span> <span class="s">\"https://${var.customer_name}-apim.azurefd.net/${var.customer_name}-app-database-microservice\",\"key\": \"${azurerm_api_management_subscription.subscription.primary_key}\"}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "REDISCACHEHOSTNAME" {</span>
  <span class="s">name         = "REDISCACHEHOSTNAME"</span>
  <span class="s">value        = azurerm_redis_cache.redis.hostname</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "REDISCACHEKEY" {</span>
  <span class="s">name         = "REDISCACHEKEY"</span>
  <span class="s">value        = azurerm_redis_cache.redis.primary_access_key</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "AZURE_STORAGE" {</span>
  <span class="s">name         = "AZURE-STORAGE"</span>
  <span class="s">value        = "{\"connection_string\":\"${azurerm_storage_account.srg.primary_connection_string}\",\"container_image\":\"kb-attachment\",\"cdn_url\":\"https://${var.customer_name}-cdn.azureedge.net/\"}"</span>
  <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "FIREBASE_ADMIN_AUTH" {</span>
   <span class="s">name         = "FIREBASE-ADMIN-AUTH"</span>
   <span class="s">value        = "${var.FIREBASE_ADMIN_AUTH}"</span>
   <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "FIREBASE_ADMIN_ENDPOINT" {</span>
   <span class="s">name         = "FIREBASE-ADMIN-ENDPOINT"</span>
   <span class="s">value        = "${var.FIREBASE_ADMIN_ENDPOINT}"</span>
   <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">resource "azurerm_key_vault_secret" "AZURE_SERVICEBUS_CONNECTIONSTRING" {</span>
   <span class="s">name         = "AZURE-SERVICEBUS-CONNECTIONSTRING"</span>
   <span class="s">value        = azurerm_servicebus_namespace.servicebus.default_primary_connection_string</span>
   <span class="s">key_vault_id = azurerm_key_vault.srg.id</span>
<span class="err">}</span>
<span class="s">//service bus</span>
<span class="s">resource "azurerm_servicebus_namespace" "servicebus" {</span>
  <span class="s">name                = "${var.customer_name}-servicebus-namespace"</span>
  <span class="s">location            = azurerm_resource_group.srg.location</span>
  <span class="s">resource_group_name = azurerm_resource_group.srg.name</span>
  <span class="s">sku                 = "Standard"</span>

  <span class="s">tags = {</span>
    <span class="s">source = "terraform"</span>
  <span class="s">}</span>
<span class="err">}</span>
<span class="s">resource "azurerm_servicebus_topic" "topic" {</span>
  <span class="s">name                = "${var.customer_name}-topic"</span>
  <span class="s">resource_group_name = azurerm_resource_group.srg.name</span>
  <span class="s">namespace_name      = azurerm_servicebus_namespace.servicebus.name</span>

  <span class="s">enable_partitioning = </span><span class="no">true</span>
<span class="err">}</span>

<span class="s">resource "azurerm_servicebus_subscription" "subscription" {</span>
  <span class="s">name                = "notification"</span>
  <span class="s">resource_group_name = azurerm_resource_group.srg.name</span>
  <span class="s">namespace_name      = azurerm_servicebus_namespace.servicebus.name</span>
  <span class="s">topic_name          = azurerm_servicebus_topic.topic.name</span>
  <span class="s">max_delivery_count  = </span><span class="m">1</span>
<span class="err">}</span>
</code></pre></div></div> </div> </div> <div class="search-overlay"></div> </div> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>
